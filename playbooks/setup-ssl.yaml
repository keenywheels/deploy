---
- name: setup/update ssl certs
  hosts: all
  become: true

  vars:
    domain_list:
      - vixar.tech
      - www.vixar.tech
    email: "dan.mironenko@gmail.com"
    webroot_path: /opt/deploy/nginx/certbot
    nginx_dir: /opt/deploy/nginx
    nginx_service: front-nginx

  tasks:
    - name: check webroot path exists
      ansible.builtin.file:
        path: "{{ webroot_path }}"
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"

    - name: install certbot and dependencies
      ansible.builtin.apt:
        name:
          - certbot
          - python3-certbot-nginx
        state: latest
        update_cache: yes

    - name: obtain or renew certs
      ansible.builtin.command: >
        certbot certonly
        --webroot -w {{ webroot_path }}
        {% for d in domain_list %} -d {{ d }}{% endfor %}
        --non-interactive --agree-tos --email {{ email }}
      register: certbot_result
      changed_when: "'Congratulations' in certbot_result.stdout or 'Successfully' in certbot_result.stdout"

    - name: reload nginx if certs changed
      ansible.builtin.command:
        chdir: "{{ nginx_dir }}"
        cmd: docker compose -f compose.yaml restart {{ nginx_service }}
      when: certbot_result.changed

    - name: setup certbot auto-renew
      ansible.builtin.cron:
        name: "certbot auto-renew"
        user: ubuntu
        minute: "0"
        hour: "3"
        job: >
          certbot renew --quiet --post-hook
          "docker compose -f {{ nginx_dir }}/compose.yaml restart {{ nginx_service }}"
        state: present
